<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlgoTrader Pro Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-green: #00c853;
            --accent-red: #ff3d00;
            --accent-blue: #2979ff;
            --border-color: #333;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            /* Mobilde kenar boşluğu azaltıldı */
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            letter-spacing: 1px;
        }

        h1 span {
            color: var(--accent-blue);
            font-weight: 600;
        }

        /* İstatistik Kartları */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            /* Mobilde de 3 sütun sığdırmaya çalış */
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            /* Çok küçük ekranda alt alta */
        }

        .card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .card h3 {
            margin: 0 0 5px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .card .number {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .c-blue {
            color: var(--accent-blue);
        }

        .c-green {
            color: var(--accent-green);
        }

        .c-red {
            color: var(--accent-red);
        }

        /* Kontrol Paneli (MOBİL UYUMLU DÜZEN) */
        .control-panel {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            /* Alt alta sırala */
            gap: 15px;
            margin-bottom: 30px;
        }

        input[type="text"] {
            background-color: #2c2c2c;
            border: 1px solid var(--border-color);
            color: white;
            padding: 15px;
            border-radius: 8px;
            width: 100%;
            /* Tam genişlik */
            font-size: 1.1rem;
            text-transform: uppercase;
            box-sizing: border-box;
            /* Padding dahil hesapla */
        }

        .button-group {
            display: flex;
            gap: 10px;
            width: 100%;
        }

        button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            font-size: 1rem;
            flex: 1;
            /* Eşit genişlikte dağıl */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-add {
            background-color: var(--accent-blue);
            color: white;
        }

        .btn-scan {
            background-color: var(--accent-green);
            color: black;
        }

        /* Listeler */
        .lists-container {
            display: grid;
            grid-template-columns: 1fr;
            /* Mobilde tek sütun */
            gap: 20px;
        }

        @media (min-width: 768px) {
            .lists-container {
                grid-template-columns: 2fr 1fr;
            }

            /* Masaüstünde yan yana */
            .control-panel {
                flex-direction: row;
            }

            /* Masaüstünde yan yana */
            .button-group {
                width: auto;
            }

            input[type="text"] {
                width: auto;
                flex-grow: 1;
            }
        }

        .list-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #252525;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid transparent;
        }

        li.status-neutral {
            border-left-color: #555;
        }

        li.status-buy {
            border-left-color: var(--accent-green);
            background-color: rgba(0, 200, 83, 0.1);
        }

        li.status-sell {
            border-left-color: var(--accent-red);
            background-color: rgba(255, 61, 0, 0.1);
        }

        li.status-error {
            border-left-color: #ffb74d;
            color: #ffb74d;
        }

        .action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px 10px;
        }

        .action-btn:hover {
            color: var(--accent-red);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-buy {
            background-color: var(--accent-green);
            color: black;
        }

        .badge-sell {
            background-color: var(--accent-red);
            color: white;
        }

        .badge-wait {
            background-color: #444;
            color: #ccc;
        }

        /* Auto Pilot Styles */
        .autopilot-section {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .autopilot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2196F3;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        /* Log Table */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .log-table th,
        .log-table td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #333;
        }

        .log-table th {
            color: #888;
            font-weight: 600;
        }

        .log-table tr:hover {
            background-color: #252525;
        }

        .ap-card {
            background: #252525;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <header>
            <h1>Algo<span>Trader</span></h1>
            <div style="color: var(--text-muted); font-size: 0.9rem;">
                <i class="fas fa-clock"></i> <span id="clock">00:00</span>
            </div>
        </header>

        <!-- AUTO PILOT SECTION -->
        <div class="autopilot-section">
            <div class="autopilot-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-robot fa-lg" style="color:var(--accent-blue);"></i>
                    <h2 style="margin:0; font-size:1.3rem;">Otomatik Pilot</h2>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span id="ap-status-text" style="color:#888; font-size:0.9rem;">DEVRE DIŞI</span>
                    <label class="switch">
                        <input type="checkbox" id="autopilot-toggle" onchange="toggleAutoPilot()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <!-- AP Stats -->
            <div style="display:flex; gap:15px; flex-wrap:wrap; margin-bottom:20px;">
                <div class="ap-card">
                    <div style="color:#888; font-size:0.8rem;">Toplam Varlık</div>
                    <div id="ap-total-value" style="font-size:1.4rem; font-weight:bold; color:white;">100,000.00 ₺</div>
                </div>
                <div class="ap-card">
                    <div style="color:#888; font-size:0.8rem;">Nakit (Kasa)</div>
                    <div id="ap-cash" style="font-size:1.2rem; font-weight:bold; color:var(--accent-green);">100,000.00
                        ₺</div>
                </div>
                <div class="ap-card">
                    <div style="color:#888; font-size:0.8rem;">Hisse Değeri</div>
                    <div id="ap-stock-value" style="font-size:1.2rem; font-weight:bold; color:var(--accent-blue);">0.00
                        ₺</div>
                </div>
            </div>

            <!-- AP Logs -->
            <h3 style="font-size:1rem; color:#aaa; margin-bottom:10px;">Günlük İşlemler</h3>
            <div style="max-height: 250px; overflow-y: auto; background:#222; border-radius:8px;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Saat</th>
                            <th>İşlem</th>
                            <th>Sembol</th>
                            <th>Fiyat</th>
                            <th>Adet</th>
                            <th>Tutar</th>
                            <th>Not</th>
                        </tr>
                    </thead>
                    <tbody id="ap-log-body">
                        <tr>
                            <td colspan="7" style="text-align:center; color:#555;">İşlem yok.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="stats-grid">
            <div class="card">
                <h3>Takip</h3>
                <div class="number c-blue" id="total-stocks">0</div>
            </div>
            <div class="card">
                <h3>Sinyal</h3>
                <div class="number c-green" id="buy-signals">0</div>
            </div>
            <div class="card">
                <h3>Hata</h3>
                <div class="number c-red" id="error-stocks">0</div>
            </div>
        </div>

        <div class="control-panel">
            <input type="text" id="stock-input" placeholder="HİSSE KODU (ÖRN: GARAN.IS)">
            <div class="button-group">
                <button class="btn-add" onclick="addStock()"><i class="fas fa-plus"></i> EKLE</button>
                <button class="btn-scan" onclick="simulateScan()"><i class="fas fa-sync"></i> TARA</button>
            </div>
        </div>

        <div class="lists-container">
            <!-- Sol Kolon: Portföy ve Takip Listesi -->
            <div style="display:flex; flex-direction:column; gap:20px;">

                <!-- Portföy (İşlem Olanlar) -->
                <div class="list-section">
                    <div class="list-header">
                        <h3><i class="fas fa-briefcase"></i> Portföyüm</h3>
                    </div>
                    <ul id="portfolio-stock-list">
                        <li style="text-align:center; color:#666; font-size:0.9rem;">Portföyünüzde hisse yok.</li>
                    </ul>
                </div>

                <!-- Takip Listesi (Sadece İzlenenler) -->
                <div class="list-section">
                    <div class="list-header">
                        <h3><i class="fas fa-eye"></i> Takip Listesi</h3>
                    </div>
                    <ul id="watchlist-stock-list">
                        <li style="text-align:center; color:#666; font-size:0.9rem;">Takip listeniz boş.</li>
                    </ul>
                </div>

            </div>

            <!-- Sağ Kolon: Sinyaller -->
            <div class="list-section">
                <div class="list-header">
                    <h3><i class="fas fa-bolt"></i> Canlı Sinyaller</h3>
                </div>
                <ul id="signal-list">
                    <li style="text-align:center; color:#555; font-size: 0.9rem;">Sinyal yok.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div id="ai-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div
            style="background:var(--card-bg); padding:24px; border-radius:12px; max-width:600px; width:90%; max-height:80vh; overflow-y:auto; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <button onclick="closeModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; opacity:0.7;">&times;</button>
            <h3 id="modal-title"
                style="margin-top:0; color:var(--accent-blue); font-size:1.4rem; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                Analiz</h3>
            <div id="modal-content" class="markdown-body"
                style="line-height:1.6; color:#ddd; margin-top:15px; font-size:0.95rem;">
                Yükleniyor...
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="transaction-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1001; align-items:center; justify-content:center;">
        <div
            style="background:var(--card-bg); padding:24px; border-radius:12px; width:90%; max-width:400px; position:relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
            <button onclick="closeTransactionModal()"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            <h3
                style="margin-top:0; color:var(--text-primary); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                İşlem Ekle: <span id="trans-symbol" style="color:var(--accent-blue);"></span>
            </h3>

            <div style="display:flex; flex-direction:column; gap:15px; margin-top:20px;">
                <div>
                    <label style="display:block; font-size:0.8rem; color:#888; margin-bottom:5px;">İşlem Tipi</label>
                    <select id="trans-type"
                        style="width:100%; background:#2a2a2a; border:1px solid #444; color:white; padding:10px; border-radius:6px;">
                        <option value="BUY">ALIM (BUY)</option>
                        <option value="SELL">SATIŞ (SELL)</option>
                    </select>
                </div>

                <div>
                    <label style="display:block; font-size:0.8rem; color:#888; margin-bottom:5px;">Adet</label>
                    <input type="number" id="trans-amount" placeholder="0"
                        style="width:100%; background:#2a2a2a; border:1px solid #444; color:white; padding:10px; border-radius:6px;">
                </div>

                <div>
                    <label style="display:block; font-size:0.8rem; color:#888; margin-bottom:5px;">Fiyat (TL)</label>
                    <input type="number" step="0.01" id="trans-price" placeholder="0.00"
                        style="width:100%; background:#2a2a2a; border:1px solid #444; color:white; padding:10px; border-radius:6px;">
                </div>

                <button onclick="saveTransaction()"
                    style="background:var(--accent-blue); color:white; border:none; padding:12px; border-radius:6px; font-weight:bold; cursor:pointer; margin-top:10px;">
                    KAYDET
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Markdown Styles for Modal */
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            color: var(--accent-blue);
            margin-top: 15px;
            margin-bottom: 10px;
        }

        .markdown-body strong {
            color: #fff;
        }

        .markdown-body ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }

        .markdown-body li {
            margin-bottom: 5px;
        }

        .markdown-body p {
            margin-bottom: 10px;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // --- AYARLAR (BURAYI DOLDUR) ---
        const SUPABASE_URL = "https://ckgwpxsaclakcdzitzrb.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNrZ3dweHNhY2xha2Nkeml0enJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjAzMjQsImV4cCI6MjA4NjkzNjMyNH0.Hl02XgwwHOWyYrI0fcH7OH19IwTSFX4z5Zhjlc8rvQY";

        // --- BAĞLANTIYI KUR (DÜZELTİLMİŞ KISIM) ---
        // Global 'supabase' nesnesinden createClient fonksiyonunu alıyoruz
        // Çakışmayı önlemek için değişken adını 'supabaseClient' yaptık
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- VERİ YÖNETİMİ (Portföy için) ---
        let stocks = [];

        // --- AUTO PILOT FONKSİYONLARI ---
        let apInterval = null;

        async function fetchAutoPilotStatus() {
            try {
                const res = await fetch('/api/autopilot/status');
                if (!res.ok) return;
                const data = await res.json();

                // Update UI
                const toggle = document.getElementById('autopilot-toggle');
                const statusText = document.getElementById('ap-status-text');

                // Toggle state (sadece ilk seferde veya dışardan değiştiyse, kullanıcı etkileşimi sırasında çakışmasın)
                toggle.checked = data.active;
                statusText.innerText = data.active ? "AKTİF" : "DEVRE DIŞI";
                statusText.style.color = data.active ? "var(--accent-green)" : "#888";

                // Stats
                document.getElementById('ap-total-value').innerText = data.total_value.toFixed(2) + " ₺";
                document.getElementById('ap-cash').innerText = data.cash.toFixed(2) + " ₺";
                const stockVal = data.total_value - data.cash;
                document.getElementById('ap-stock-value').innerText = stockVal.toFixed(2) + " ₺";

                // Logs
                renderLogs(data.logs);

            } catch (e) {
                console.error("AP Status Error:", e);
            }
        }

        async function toggleAutoPilot() {
            const toggle = document.getElementById('autopilot-toggle');
            const newState = toggle.checked;

            try {
                const res = await fetch('/api/autopilot/toggle', {
                    method: 'POST',
                    body: JSON.stringify({ state: newState }),
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                // UI update from response
                const statusText = document.getElementById('ap-status-text');
                statusText.innerText = data.active ? "AKTİF" : "DEVRE DIŞI";
                statusText.style.color = data.active ? "var(--accent-green)" : "#888";

                fetchAutoPilotStatus(); // Refresh all stats
            } catch (e) {
                console.error("Toggle Error:", e);
                toggle.checked = !newState; // Revert on error
            }
        }

        function renderLogs(logs) {
            const tbody = document.getElementById('ap-log-body');
            tbody.innerHTML = '';

            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#555;">İşlem yok.</td></tr>';
                return;
            }

            logs.forEach(log => {
                const tr = document.createElement('tr');
                const color = log.action === 'ALIM' ? 'var(--accent-green)' : (log.action === 'SATIŞ' ? 'var(--accent-blue)' : 'var(--accent-red)');

                tr.innerHTML = `
                    <td style="color:#aaa;">${log.timestamp.split(' ')[1]}</td>
                    <td style="color:${color}; font-weight:bold;">${log.action}</td>
                    <td>${log.symbol}</td>
                    <td>${log.price.toFixed(2)}</td>
                    <td>${log.amount}</td>
                    <td>${log.total.toFixed(2)}</td>
                    <td style="color:#888; font-size:0.8rem;">${log.note}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- YAPAY ZEKA ANALİZİ ---
        async function analyzeStock(symbol) {
            const modal = document.getElementById('ai-modal');
            const title = document.getElementById('modal-title');
            const content = document.getElementById('modal-content');

            modal.style.display = 'flex';
            title.innerText = `${symbol} Analizi (AI)`;
            content.innerHTML = '<div style="text-align:center;"><i class="fas fa-spinner fa-spin fa-2x"></i><br><br>Yapay Zeka Analiz Ediyor...</div>';

            try {
                const response = await fetch(`/api/analyze/${symbol}`);
                if (!response.ok) throw new Error("Analiz hatası");

                const data = await response.json();

                // Markdown'ı HTML'e çevir (marked.js kullanarak)
                if (data.analysis) {
                    content.innerHTML = marked.parse(data.analysis);
                } else {
                    content.innerText = "Analiz yapılamadı.";
                }

            } catch (error) {
                console.error(error);
                content.innerHTML = `<span style="color:var(--accent-red)">Hata: ${error.message}</span>`;
            }
        }

        function closeModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        // --- GLOBAL DEĞİŞKENLER ---
        let portfolioItems = []; // API'den gelen özet veri

        // --- PORTFÖYÜ GETİR (HİBRİT MANTIK) ---
        async function fetchPortfolio() {
            try {
                // 1. Transaction Özetini Çek (Server)
                const summaryResp = await fetch('/api/portfolio/summary');
                const summaryData = summaryResp.ok ? await summaryResp.json() : { items: [], total_value: 0, total_pl: 0 };

                // 2. Portfolio Tablosunu Çek (Supabase - Eski yöntemle eklenenler)
                const { data: simplePortfolio, error } = await supabaseClient
                    .from('portfolio')
                    .select('*');

                if (error) console.error("Supabase portföy hatası:", error);

                // 3. Verileri Birleştir
                let mergedItems = summaryData.items ? [...summaryData.items] : [];

                // Debug Bilgisi
                console.log("Transaction Items:", summaryData.items);
                console.log("Simple Portfolio:", simplePortfolio);

                const transactionSymbols = new Set(mergedItems.map(i => i.symbol));

                if (simplePortfolio) {
                    for (const item of simplePortfolio) {
                        if (!transactionSymbols.has(item.symbol)) {
                            // Hiç işlem yoksa varsayılan değerlerle ekle
                            mergedItems.push({
                                symbol: item.symbol,
                                quantity: 0,
                                avg_cost: 0,
                                current_price: 0, // Render sırasında çekilecek veya aşağıda güncellenecek
                                market_value: 0,
                                pl: 0,
                                pl_percent: 0,
                                is_simple_watch: true // Sadece izleme listesinde
                            });
                        }
                    }
                }

                portfolioItems = mergedItems;

                // Header İstatistiklerini Güncelle
                updateHeaderStats(summaryData);

                renderList();
            } catch (error) {
                console.error("Portföy hatası:", error);
            }
        }

        function updateHeaderStats(data) {
            let totalValEl = document.getElementById('total-value-display');
            if (!totalValEl) {
                const headerContent = document.querySelector('.header-content');
                if (headerContent) {
                    const statsDiv = document.createElement('div');
                    statsDiv.id = 'total-value-display';
                    statsDiv.style.textAlign = 'right';
                    statsDiv.style.fontSize = '0.9rem';
                    headerContent.appendChild(statsDiv);
                    totalValEl = statsDiv;
                }
            }

            if (totalValEl) {
                const plClass = data.total_pl >= 0 ? 'c-green' : 'c-red';
                const sign = data.total_pl >= 0 ? '+' : '';

                totalValEl.innerHTML = `
                    <div style="color:#aaa;">Toplam Değer</div>
                    <div style="font-size:1.2rem; font-weight:bold;">${data.total_value.toFixed(2)} ₺</div>
                    <div class="${plClass}">
                        K/Z: ${sign}${data.total_pl.toFixed(2)} ₺
                    </div>
                `;
            }
        }

        // --- SAYFA YÜKLENDİĞİNDE ÇALIŞACAKLAR ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchPortfolio();
            fetchSignals();
            startTime();

            const input = document.getElementById("stock-input");
            if (input) {
                input.addEventListener("keypress", function (event) {
                    if (event.key === "Enter") addStock();
                });
            }
        });

        // --- VERİTABANINDAN SİNYAL OKUMA ---
        async function fetchSignals() {
            const btn = document.querySelector('.btn-scan');
            if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Yükleniyor...';

            // Düzeltme: Artık 'supabaseClient' kullanıyoruz
            const { data, error } = await supabaseClient
                .from('signals')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10); // Son 10 sinyali getir

            if (error) {
                console.error("Veri çekme hatası:", error);
                if (btn) btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Hata';
                return;
            }

            // Sinyal Listesini Temizle ve Doldur
            const signalListEl = document.getElementById('signal-list');
            if (signalListEl) {
                signalListEl.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(signal => {
                        const li = document.createElement('li');
                        const isBuy = signal.status === 'AL';
                        li.className = isBuy ? 'status-buy' : 'status-sell';
                        const badgeClass = isBuy ? 'badge-buy' : 'badge-sell';
                        const typeText = isBuy ? 'ALIM' : 'SATIŞ';

                        // Tarihi formatla (Örn: 14:30)
                        const date = new Date(signal.created_at).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                        li.innerHTML = `
                        <div style="display:flex; flex-direction:column;">
                            <strong>${signal.symbol}</strong>
                            <span style="font-size:0.75rem; color:#ccc;">${date} • ${typeText}</span>
                        </div>
                        <div style="text-align:right;">
                            <span class="badge ${badgeClass}">${signal.price}</span>
                            <div style="font-size:0.7rem; color:#888;">RSI: ${signal.rsi}</div>
                        </div>
                    `;
                        signalListEl.appendChild(li);
                    });

                    // İstatistik güncelle
                    updateStats(data.length);
                } else {
                    signalListEl.innerHTML = '<li style="text-align:center; color:#555;">Henüz sinyal yok.</li>';
                    updateStats(0);
                }
            }

            if (btn) btn.innerHTML = '<i class="fas fa-sync"></i> YENİLE';
        }

        // --- FİYAT ÇEKME (Portföy İçin) ---
        // --- FİYAT ÇEKME (Portföy İçin) ---
        // --- FİYAT ÇEKME (Portföy İçin) ---
        async function fetchStockData(symbol, elementId, item) {
            try {
                // Yerel Sunucudan Çek (server.py)
                const response = await fetch(`/api/quote/${symbol}`);

                if (!response.ok) throw new Error("Sunucu hatası");
                const data = await response.json();

                const price = data.price;
                const prevClose = data.prev_close;

                if (price === undefined) return;

                const el = document.getElementById(elementId);
                if (!el) return;

                // --- PORTFÖY ÜRÜNÜ (Miktar Var) ---
                if (item && item.quantity > 0) {
                    const marketValue = price * item.quantity;
                    const totalCost = item.avg_cost * item.quantity;
                    const pl = marketValue - totalCost;
                    const plPercent = totalCost > 0 ? (pl / totalCost) * 100 : 0;

                    const colorClass = pl >= 0 ? 'c-green' : 'c-red';
                    const sign = pl >= 0 ? '+' : '';

                    el.innerHTML = `
                        <div style="text-align:right;">
                             <!-- Toplam Tutar (Market Value) -->
                            <div style="font-size:1.1rem; font-weight:bold;">${marketValue.toFixed(2)} ₺</div>
                            
                            <!-- Birim Fiyat -->
                            <div style="font-size:0.75rem; color:#888;">${price.toFixed(2)} ₺</div>

                            <!-- Kar/Zarar -->
                            <div class="${colorClass}" style="font-size:0.85rem; font-weight:bold;">
                                ${sign}${pl.toFixed(2)} ₺ (${sign}${plPercent.toFixed(2)}%)
                            </div>
                        </div>
                    `;
                }
                // --- TAKİP LİSTESİ (Günlük Değişim Göster) ---
                else if (prevClose !== undefined) {
                    const change = price - prevClose;
                    const changePercent = (change / prevClose) * 100;
                    const colorClass = change >= 0 ? 'c-green' : 'c-red';
                    const sign = change >= 0 ? '+' : '';

                    el.innerHTML = `
                        <div style="text-align:right;">
                            <div style="font-size:1.1rem; font-weight:bold;">${price.toFixed(2)} ₺</div>
                            <div class="${colorClass}" style="font-size:0.85rem;">
                                ${sign}${change.toFixed(2)} (${sign}${changePercent.toFixed(2)}%)
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`${symbol} fiyatı çekilemedi:`, error);
                // Hata durumunda UI'ı bozma, eski değer kalsın veya basit uyarı ver
            }
        }

        // --- LİSTELEME ---
        function renderList() {
            const portfolioEl = document.getElementById('portfolio-stock-list');
            const watchlistEl = document.getElementById('watchlist-stock-list');

            if (!portfolioEl || !watchlistEl) return;

            portfolioEl.innerHTML = '';
            watchlistEl.innerHTML = '';

            // Grupları Ayır
            const activePortfolio = portfolioItems.filter(i => !i.is_simple_watch);
            const watchList = portfolioItems.filter(i => i.is_simple_watch);

            // --- PORTFÖY RENDER ---
            if (activePortfolio.length === 0) {
                portfolioEl.innerHTML = '<li style="text-align:center; color:#666; font-size:0.9rem;">Henüz işlem yapılmış hisse yok.</li>';
            } else {
                activePortfolio.forEach((item, index) => {
                    const li = createStockListItem(item, index, false);
                    portfolioEl.appendChild(li);
                    // Fiyat güncelleme
                    fetchStockData(item.symbol, `price-p-${index}-${item.symbol}`, item);
                });
            }

            // --- TAKİP LİSTESİ RENDER ---
            if (watchList.length === 0) {
                watchlistEl.innerHTML = '<li style="text-align:center; color:#666; font-size:0.9rem;">Takip listeniz boş.</li>';
            } else {
                watchList.forEach((item, index) => {
                    const li = createStockListItem(item, index, true);
                    watchlistEl.appendChild(li);
                    // Fiyat güncelleme (takip için farklı ID prefix kullanabiliriz ama index yeterli)
                    fetchStockData(item.symbol, `price-w-${index}-${item.symbol}`, item);
                });
            }

            const totalEl = document.getElementById('total-stocks');
            if (totalEl) totalEl.innerText = portfolioItems.length;
        }

        function createStockListItem(item, index, isWatchList) {
            const li = document.createElement('li');
            li.className = isWatchList ? 'status-neutral' : (item.pl >= 0 ? 'status-buy' : 'status-sell');
            if (isWatchList) li.style.borderLeftColor = "#555"; // Override

            // Unique ID
            const priceId = isWatchList ? `price-w-${index}-${item.symbol}` : `price-p-${index}-${item.symbol}`;

            let plHtml = '';
            if (!isWatchList) {
                const plClass = item.pl >= 0 ? 'c-green' : 'c-red';
                const sign = item.pl >= 0 ? '+' : '';
                plHtml = `
                    <div class="${plClass}" style="font-size:0.85rem; font-weight:bold;">
                        ${sign}${item.pl.toFixed(2)} ₺ 
                        <span style="font-size:0.75rem; opacity:0.8;">(${sign}${item.pl_percent.toFixed(2)}%)</span>
                    </div>
                `;
            } else {
                plHtml = `<div style="font-size:0.8rem; color:#888;">İzleniyor</div>`;
            }

            const qtyDisplay = item.quantity > 0 ? `x${item.quantity}` : '';

            li.innerHTML = `
                <div style="display:flex; flex-direction:column; gap:5px; width:100%;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="action-btn" onClick="removeStock('${item.symbol}')" title="Listeden Sil"><i class="fas fa-trash"></i></button>
                            <strong>${item.symbol}</strong>
                            <span style="font-size:0.8rem; color:#888;">${qtyDisplay}</span>
                        </div>
                        <div id="${priceId}" style="text-align:right;">
                            <div style="font-weight:bold;">${item.current_price ? item.current_price + ' ₺' : '<i class="fas fa-spinner fa-spin"></i>'}</div>
                            ${plHtml}
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button onclick="openTransactionModal('${item.symbol}')" style="flex:1; background:#444; border:none; color:white; padding:4px; border-radius:4px; font-size:0.75rem; cursor:pointer;">
                            <i class="fas fa-plus-minus"></i> İşlem
                        </button>
                        <button onclick="analyzeStock('${item.symbol}')" style="flex:1; background:none; border:1px solid var(--accent-blue); color:var(--accent-blue); border-radius:4px; padding:4px; cursor:pointer; font-size:0.75rem;">
                            <i class="fas fa-magic"></i> AI
                        </button>
                    </div>
                    
                    ${!isWatchList ? `<div style="font-size:0.75rem; color:#666; margin-top:2px;">Ort. Maliyet: ${item.avg_cost} ₺</div>` : ''}
                </div>
            `;
            return li;
        }

        // --- TRANSACTION LOGIC (Global Scope) ---
        async function openTransactionModal(symbol) {
            const el = document.getElementById('trans-symbol');
            if (el) el.innerText = symbol;

            // Eski değerleri temizle
            const amountEl = document.getElementById('trans-amount');
            if (amountEl) amountEl.value = '';

            const priceEl = document.getElementById('trans-price');
            // Reset price field and show loading indicator (placeholder)
            if (priceEl) {
                priceEl.value = '';
                priceEl.placeholder = 'Fiyat yükleniyor...';
            }

            const modal = document.getElementById('transaction-modal');
            if (modal) {
                modal.style.display = 'flex';
                // Animasyonlu giriş veya odaklanma
                if (amountEl) setTimeout(() => amountEl.focus(), 100);
            }

            // Fetch current price
            try {
                const response = await fetch(`/api/quote/${symbol}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.price !== undefined && priceEl) {
                        priceEl.value = data.price.toFixed(2);
                    }
                }
            } catch (e) {
                console.error("Fiyat çekme hatası:", e);
            } finally {
                if (priceEl && !priceEl.value) priceEl.placeholder = '0.00';
            }
        }

        function closeTransactionModal() {
            const modal = document.getElementById('transaction-modal');
            if (modal) modal.style.display = 'none';
        }

        async function saveTransaction() {
            const symbolEl = document.getElementById('trans-symbol');
            const symbol = symbolEl ? symbolEl.innerText : null;

            const typeEl = document.getElementById('trans-type');
            const type = typeEl ? typeEl.value : 'BUY';

            const amountEl = document.getElementById('trans-amount');
            const amount = amountEl ? amountEl.value : 0;

            const priceEl = document.getElementById('trans-price');
            const price = priceEl ? priceEl.value : 0;

            if (!symbol || !amount || !price) {
                alert("Lütfen adet ve fiyat giriniz.");
                return;
            }

            const btn = document.querySelector('#transaction-modal button[onclick="saveTransaction()"]');
            const originalText = btn ? btn.innerText : 'KAYDET';
            if (btn) btn.innerText = "Kaydediliyor...";

            try {
                const { error } = await supabaseClient
                    .from('transactions')
                    .insert({
                        symbol: symbol,
                        type: type,
                        amount: parseInt(amount),
                        price: parseFloat(price)
                    });

                if (error) throw error;

                closeTransactionModal();
                fetchPortfolio();

            } catch (error) {
                alert("Hata: " + error.message);
                console.error(error);
            } finally {
                if (btn) btn.innerText = "KAYDET";
            }
        }

        function updateStats(signalCount) {
            const signalEl = document.getElementById('buy-signals');
            if (signalEl) signalEl.innerText = signalCount;
        }

        // --- ADD STOCK (Hisse Ekle / İşlem Gir) ---
        async function addStock() {
            const input = document.getElementById('stock-input');
            let symbol = input.value.trim().toUpperCase();

            // BIST varsayımı
            if (symbol && !symbol.includes('.') && symbol.length <= 5) {
                symbol += ".IS";
            }

            if (!symbol) return;

            const btn = document.querySelector('.btn-add');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                // Check duplicate check (optional but good UX)
                if (portfolioItems.find(i => i.symbol === symbol)) {
                    alert("Bu hisse zaten listenizde ekli.");
                    input.value = '';
                    return;
                }

                // Sadece izleme listesine (portfolio tablosuna) ekle
                const { error } = await supabaseClient
                    .from('portfolio')
                    .insert([{ symbol: symbol }]);

                if (error) throw error;

                await fetchPortfolio();
                input.value = '';

            } catch (err) {
                console.error(err);
                alert("Hata: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function removeStock(symbol) {
            // Hangi tablodan sileceğimize karar verelim
            const item = portfolioItems.find(i => i.symbol === symbol);
            if (!item) return;

            // Find the button associated with this symbol to update its state
            // This assumes the button has a unique identifier or can be found relative to the symbol
            // For simplicity, we'll just update the specific button that triggered the action.
            // In renderList, the button is `onClick="removeStock('${item.symbol}')"`.
            // We can't easily get a reference to *that specific button* here without more DOM context.
            // For now, we'll skip the spinner on the button itself, or assume the whole list re-renders quickly.

            if (item.is_simple_watch) {
                // Sadece izleme listesinden sil (Portfolio tablosu)
                if (!confirm(symbol + " izleme listesinden silinecek. Emin misin?")) return;

                const { error } = await supabaseClient
                    .from('portfolio')
                    .delete()
                    .eq('symbol', symbol);

                if (error) alert("Hata: " + error.message);
                else fetchPortfolio();

            } else {
                // İşlem geçmişi var, transactions tablosundan sil
                if (!confirm(symbol + " hissesine ait TÜM İŞLEM GEÇMİŞİ ve portföy kaydı silinecek. Emin misin?")) return;

                const { error } = await supabaseClient
                    .from('transactions')
                    .delete()
                    .eq('symbol', symbol);

                if (error) alert("Hata: " + error.message);
                else fetchPortfolio();
            }
        }

        // saveData removed (Supabase Persistent)

        // Butona basınca verileri tekrar çekmesi için fonksiyonu bağlıyoruz
        window.simulateScan = fetchSignals;

        // 30 saniyede bir portföy fiyatlarını güncelle
        setInterval(() => {
            renderList();
        }, 30000);

        // --- SAAT FONKSİYONU ---
        function startTime() {
            const clockEl = document.getElementById('clock');
            if (clockEl) {
                const today = new Date();
                let h = today.getHours();
                let m = today.getMinutes();
                m = m < 10 ? "0" + m : m;
                clockEl.innerHTML = h + ":" + m;
            }
            setTimeout(startTime, 1000);
        }
    </script>

</body>

</html>